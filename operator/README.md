# Vimana Operator

An implementation of the [K8s operator pattern] to manage Vimana's [custom resources].

## Operator SDK

Boilerplate was generated by the [Operator SDK],
which normally uses Make but has been adapted to Bazel.

Major adaptations include:

- Building the Docker image with [`rules_oci`] instead of a Dockerfile.
- Downloading a pre-built [`controller-gen`] release from GitHub
  instead of using `go install`.
- Downloading pre-built `etcd` and `kube-apiserver` binaries
  via the Bazel downloader rather than relying on [`setup-envtest`].

Despite taking as many measures as practical to use Bazel best practices,
certain Operator SDK actions like `make generate` or `make deploy`
are jury-rigged using executable rules that mutate the source tree in-place.

[`rules_oci`]: https://github.com/bazel-contrib/rules_oci
[`setup-envtest`]: https://pkg.go.dev/sigs.k8s.io/controller-runtime/tools/setup-envtest
[`controller-gen`]: https://github.com/kubernetes-sigs/controller-tools

## Custom Resources

## Deployment

**Build and push the operator image to the local container registry**

```bash
bazel run //operator:image-push-local
```

**Install the CRDs into the cluster:**

```bash
KUBECONFIG=<optional> bazel run //operator:install
```

**Deploy the Manager to the cluster with the image specified by `IMG`:**

```bash
bazel run //operator:kustomize-manager
KUBECONFIG=<optional> bazel run //operator:deploy
```

> **NOTE**: If you encounter RBAC errors, you may need to grant yourself cluster-admin
privileges or be logged in as admin.

**Create instances of your solution**
You can apply the samples (examples) from the config/sample:

```bash
kubectl apply -k config/samples/
```

>**NOTE**: Ensure that the samples has default values to test it out.

### To Uninstall
**Delete the instances (CRs) from the cluster:**

```bash
kubectl delete -k config/samples/
```

**Delete the APIs(CRDs) from the cluster:**

```bash
KUBECONFIG=<optional> bazel run //operator:uninstall
```

**UnDeploy the controller from the cluster:**

```bash
bazel run //operator:kustomize-manager
KUBECONFIG=<optional> bazel run //operator:undeploy
```
